<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MP Recovery Calculator</title>
    <style>
        label,
        .label {
            display: block;
            margin-top: 18px;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .separator {
            border: none;
            border-top: 1px solid #ccc;
            margin: 12px 0;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 420px;
            margin: 30px auto;
            padding: 20px;
            background: #f4f4f4;
            border-radius: 12px;
        }

        h2 {
            text-align: center;
            margin-top: 0;
        }

        label {
            display: block;
            margin-top: 12px;
            font-weight: bold;
        }

        select,
        input {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            font-size: 14px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
        }

        .result {
            margin-top: 14px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px 12px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
        }

        .row .label {
            font-weight: bold;
        }

        .row .value {
            font-variant-numeric: tabular-nums;
        }

        .muted {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        #bonusMultiplierContainer {
            display: none;
        }

        #hideIt {
            display: none;
        }

        .final-result {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            background: #fff;
            border: 2px solid #888;
            border-radius: 10px;
            padding: 20px;
        }

        .final-result .value {
            font-variant-numeric: tabular-nums;
        }

        .rune-result {
            margin-top: 16px;
            background: #eaf7ea;
            border: 1px solid #7ac77a;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 15px;
        }

        .calculator-card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
            padding: 28px 22px 22px 22px;
            margin-top: 30px;
        }

        label span[title] {
            display: inline-block;
            margin-left: 6px;
            color: #3498db;
            font-size: 16px;
            cursor: help;
            vertical-align: middle;
            user-select: none;
        }

        .custom-tooltip-trigger {
            position: relative;
            display: inline-block;
            color: #3498db;
            font-size: 16px;
            cursor: help;
            margin-left: 6px;
            vertical-align: middle;
            user-select: none;
        }

        .custom-tooltip-content {
            display: none;
            position: absolute;
            left: 22px;
            top: 0;
            z-index: 10;
            background: #fff;
            color: #222;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 12px;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
            min-width: 220px;
            max-width: 260px;
            font-size: 13px;
            white-space: normal;
        }

        .custom-tooltip-trigger:hover .custom-tooltip-content,
        .custom-tooltip-trigger:focus .custom-tooltip-content {
            display: block;
        }
    </style>
</head>

<body>
    <div class="calculator-card">
        <h2>MP Recovery Calculator</h2>


        <label for="character">Character</label>
        <select id="character"></select>
        <div id="baseMPLabel" class="muted">Character base MP: 0</div>

        <label for="hits">Hits Needed to Charge Ultimate</label>
        <input type="number" id="hits" min="1" max="10" value="4" />
        <div class="muted">How many hits it takes to fully charge your ultimate skill.</div>

        <label for="weaponMP">Aria's Weapon MP Recovery</label>
        <select id="weaponMP">
            <option value="0">0%</option>
            <option value="10">10%</option>
            <option value="15">15%</option>
            <option value="20">20%</option>
            <option value="25">25%</option>
            <option value="30" selected>30%</option>
            <option value="35">35%</option>
        </select>

        <div style="margin-top:12px;">
            <label for="gearMP" style="display:inline-block;">
                Total MP Recovery from gears
                <span class="custom-tooltip-trigger">&#9432;
                    <span class="custom-tooltip-content">
                        <img src="mpRecOnGears.png" alt="Where to find MP Recovery on gear"
                            style="max-width:260px;display:block;margin-top:6px;border-radius:6px;">
                    </span>
                </span>
            </label>
            <input type="number" id="gearMP" min="0" max="999" step="0.01" value="0" />
            <div class="muted">
                MP Recovery shown on your gear stats.
            </div>
        </div>

        <label for="runeSlots" style="display:none;">Number of MP Recovery Runes</label>
        <select id="runeSlots" style="display:none;">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5" selected>5</option>
        </select>
        <div class="muted" style="display:none;">
            How many MP recovery runes you want to use on the character.
        </div>

        <hr class="separator">

        <div class="result" id="bonusMultiplierContainer">
            <div class="row">
                <div class="label">Total MP Recovery Needed</div>
                <div class="value" id="bonusMultiplier">0.00%</div>
            </div>
        </div>

        <div class="label">MP Recovery needed on Character window</div>
        <div class="result final-result">
            <div class="value" id="mpRecovery">0.00</div>
        </div>

        <div class="label" style="display:none;">Minimum runes needed</div>
        <div class="result final-result" style="display:none;">
            <div class="value" id="runeResult"></div>
        </div>

        <div class="label">MP Recovery rune(s) combinations</div>
        <div class="result" id="runeTableResult"></div>
    </div>
    <script>
        const characters = {
            "Yuna": 170, "Baal": 110, "Adela": 170, "Crona": 170, "Maru": 130,
            "Amethyst": 130, "Heida": 130, "Elroa": 170, "Aisha": 170, "Hana": 170,
            "Isis": 150, "Charis": 130, "Aria": 130, "Dana": 150, "Selena": 170,
            "Rebecca": 170, "Dorothy": 150, "Dr. Hela": 130, "Veronika": 200, "Alice": 150,
            "Meilin": 150, "Eswood": 140, "Noel": 170, "Alisa": 150, "Clara": 170,
            "Capt J": 150, "Priscila": 150, "Maurice": 170, "Thea": 170, "Elly": 130,
            "Lua": 150, "Milla": 200, "Shannie": 110, "Fuuka": 200, "Neya": 130,
            "Garnet": 200, "Edelweiss": 130, "Nana": 150, "Hilda": 200, "Aurora": 170,
            "Emerald": 170, "Lilith": 130, "Blair": 170, "Sherrie": 170, "R character": 100,
            "Clodia": 90
        };

        // Rune tiers, lowest to highest
        const runeTiers = [
            { tier: "F", value: 0.2, cost: 1 },
            { tier: "E", value: 3.5, cost: 10 },
            { tier: "D", value: 4, cost: 100 },
            { tier: "C", value: 6, cost: 1000 },
            { tier: "B", value: 9, cost: 10000 },
            { tier: "A", value: 11, cost: 100000 },
            { tier: "S", value: 14, cost: 1000000 },
            { tier: "SS", value: 18, cost: 10000000 },
            { tier: "SSS", value: 22, cost: 100000000 },
            { tier: "U", value: 28, cost: 1000000000 },
            { tier: "L", value: 40, cost: 10000000000 }
        ];

        const selChar = document.getElementById("character");
        const baseMPLabel = document.getElementById("baseMPLabel");
        const inpHits = document.getElementById("hits");
        const selWeapon = document.getElementById("weaponMP");
        const inpGearMP = document.getElementById("gearMP");
        const inpRuneSlots = document.getElementById("runeSlots");
        const outBonus = document.getElementById("bonusMultiplier");
        const outMP = document.getElementById("mpRecovery");
        const runeResult = document.getElementById("runeResult");

        Object.keys(characters).sort().forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            selChar.appendChild(opt);
        });
        selChar.value = "Aria";

        [selChar, inpHits, selWeapon, inpGearMP, inpRuneSlots].forEach(el => el.addEventListener("input", update));

        function getProgressiveRunes(neededPct, slots) {
            const scale = 100;
            const intNeeded = Math.ceil(neededPct * scale);
            const intTiers = runeTiers.map(rt => Math.round(rt.value * scale));
            const intCosts = runeTiers.map(rt => rt.cost);
            const maxValue = slots * Math.max(...intTiers);

            // dp[s][v] = runeCounts array or null, for s slots and value v
            const dp = Array.from({ length: slots + 1 }, () => Array(maxValue + 1).fill(null));
            dp[0][0] = Array(runeTiers.length).fill(0);

            for (let s = 0; s < slots; s++) {
                for (let v = 0; v <= maxValue; v++) {
                    if (!dp[s][v]) continue;
                    for (let t = 0; t < runeTiers.length; t++) {
                        const newV = v + intTiers[t];
                        if (newV > maxValue) continue;
                        const newCounts = dp[s][v].slice();
                        newCounts[t]++;
                        // If not set or this combination has a lower total rune cost, update
                        if (
                            !dp[s + 1][newV] ||
                            getTotalRuneCost(newCounts, intCosts) < getTotalRuneCost(dp[s + 1][newV], intCosts) ||
                            (
                                getTotalRuneCost(newCounts, intCosts) === getTotalRuneCost(dp[s + 1][newV], intCosts) &&
                                compareRuneCounts(newCounts, dp[s + 1][newV]) < 0
                            )
                        ) {
                            dp[s + 1][newV] = newCounts;
                        }
                    }
                }
            }

            // Find the minimal total rune cost for value >= neededPct with exactly 'slots' runes
            let best = null;
            let bestCost = Infinity;
            for (let v = intNeeded; v <= maxValue; v++) {
                if (dp[slots][v]) {
                    const totalCost = getTotalRuneCost(dp[slots][v], intCosts);
                    if (
                        totalCost < bestCost ||
                        (totalCost === bestCost && compareRuneCounts(dp[slots][v], best) < 0)
                    ) {
                        best = dp[slots][v];
                        bestCost = totalCost;
                    }
                }
            }
            if (!best) return null;
            return best
                .map((cnt, idx) => ({ cnt, tier: runeTiers[idx].tier }))
                .filter(obj => obj.cnt > 0);

            // Prefer more of higher tiers if cost is equal (from highest to lowest)
            function compareRuneCounts(a, b) {
                if (!b) return -1;
                for (let i = runeTiers.length - 1; i >= 0; i--) {
                    if (a[i] !== b[i]) return b[i] - a[i];
                }
                return 0;
            }
        }

        function getTotalRuneCost(counts, intCosts) {
            return counts.reduce((sum, cnt, idx) => sum + cnt * intCosts[idx], 0);
        }

        function update() {
            const baseMP = characters[selChar.value] || 0;
            baseMPLabel.textContent = `Character base MP: ${baseMP}`;

            const hits = Number(inpHits.value);
            const weaponPct = Number(selWeapon.value) || 0;
            const gearMP = parseFloat(inpGearMP.value) || 0;
            const runeSlots = Math.max(1, Math.min(5, Number(inpRuneSlots.value) || 5));

            // Require at least 1 hit
            if (!Number.isFinite(hits) || hits < 1) {
                outBonus.textContent = "—";
                outMP.textContent = "—";
                return;
            }
            // Calculate MP needed per hit, rounded up
            const mpPerHit = Math.ceil(1000 / hits);
            
            let bonusPct = (mpPerHit / (baseMP + weaponPct) - 1) * 100;
            if (!isFinite(bonusPct) || bonusPct < 0) bonusPct = 0;
            const mpRecoveryValue = baseMP * (1 + (bonusPct / 100));

            outBonus.textContent = bonusPct.toFixed(2) + "%";
            outMP.textContent = isFinite(mpRecoveryValue) ? mpRecoveryValue.toFixed(2) : "—";

            // Rune calculation: use (bonusPct - gearMP)
            let neededForRunes = bonusPct - gearMP;
            if (!isFinite(neededForRunes) || neededForRunes < 0) neededForRunes = 0;

            // Build rune table
            let tableHtml = `<table style="width:100%;font-size:15px;border-collapse:collapse;">
<tr>
  <th style="text-align:left;padding:4px 8px;"># Runes</th>
  <th style="text-align:left;padding:4px 8px;">Combination</th>
</tr>`;

            for (let slots = 1; slots <= 5; slots++) {
                if (neededForRunes === 0) {
                    tableHtml += `<tr>
            <td style="padding:4px 8px;">${slots}</td>
            <td style="padding:4px 8px;color:#090;">No runes needed</td>
        </tr>`;
                    continue;
                }

                const runes = getProgressiveRunes(neededForRunes, slots);
                if (runes) {
                    tableHtml += `<tr>
                <td style="padding:4px 8px;">${slots}</td>
                <td style="padding:4px 8px;">${runes.map(r => `${r.cnt}x ${r.tier}`).join(", ")}</td>
            </tr>`;
                } else {
                    tableHtml += `<tr>
                <td style="padding:4px 8px;">${slots}</td>
                <td style="padding:4px 8px;color:#a00;">Impossible</td>
            </tr>`;
                }
            }

            tableHtml += "</table>";
            document.getElementById("runeTableResult").innerHTML = tableHtml;
        }


        update();
    </script>
</body>